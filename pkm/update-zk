#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.12"
# dependencies = [
# ]
# ///

"""
- As a user, I want to scan all `.md` files recursively in `~/code/notes/`.
- As a user, I want to use `rg` (ripgrep) for performant file scanning.
- As a user, I want to automatically delete any file that only contains a single `#` character and optional whitespace.
- As a user, I want to automatically delete any file that contains the string `#rm`.
- As a user, I want to run additional scripts sequentially after the pruning process.
- As a user, I want to configure which additional scripts to run via a simple list of relative paths.
- As a user, I want to see clear output indicating the success or failure of each script.
- As a user, I want all output from the additional scripts to be displayed.
"""

import sys
import subprocess
from pathlib import Path

def prune_rm_notes():
    """Remove notes that contain #rm tag or only contain a single # character."""
    target_dir = Path.home() / "code" / "notes"

    if not target_dir.is_dir():
        print(f"Error: Directory not found: {target_dir}", file=sys.stderr)
        return False

    removed_files = []

    # Use rg to find files containing "#rm"
    try:
        result = subprocess.run(
            ["rg", "--files-with-matches", "--type", "md", "#rm", str(target_dir)],
            capture_output=True,
            text=True,
            check=False
        )

        if result.returncode == 0:
            files_with_rm = [Path(line.strip()) for line in result.stdout.strip().split('\n') if line.strip()]
            for file_path in files_with_rm:
                try:
                    file_path.unlink()
                    removed_files.append(str(file_path))
                except OSError as e:
                    print(f"Error: Could not remove file {file_path}: {e}", file=sys.stderr)
        elif result.returncode != 1:  # 1 means no matches found, which is fine
            print(f"Error running rg: {result.stderr}", file=sys.stderr)

    except FileNotFoundError:
        print("Error: rg (ripgrep) is not installed or not in PATH", file=sys.stderr)
        return False
    except subprocess.SubprocessError as e:
        print(f"Error running rg: {e}", file=sys.stderr)
        return False

    # Scan all .md files to find those with only a single "#" character
    for file_path in target_dir.rglob("*.md"):
        try:
            content = file_path.read_text(encoding="utf-8")

            if content.strip() == "#":
                try:
                    file_path.unlink()
                    removed_files.append(str(file_path))
                except OSError as e:
                    print(f"Error: Could not remove file {file_path}: {e}", file=sys.stderr)

        except OSError as e:
            print(f"Error: Could not read file {file_path}: {e}", file=sys.stderr)
        except UnicodeDecodeError as e:
            print(f"Error: Could not decode file {file_path} as UTF-8: {e}", file=sys.stderr)

    # Print summary of removed files
    if removed_files:
        print(f"Removed {len(removed_files)} note(s):")
        for file_path in removed_files:
            print(f"  - {file_path}")
    else:
        print("No notes were removed.")

    return True

def run_additional_scripts():
    """Run additional scripts defined in ADDITIONAL_SCRIPTS."""
    # Define scripts to run as relative paths from this script's directory
    ADDITIONAL_SCRIPTS = [
        "build-fp-note",
    ]

    script_dir = Path(__file__).parent
    all_success = True

    for script_path in ADDITIONAL_SCRIPTS:
        script_full_path = script_dir / script_path

        print(f"Running {script_path}...")

        try:
            result = subprocess.run(
                [str(script_full_path)],
                capture_output=True,
                text=True,
                check=True
            )

            # Print stdout if there's any output
            if result.stdout.strip():
                print(result.stdout.strip())

            print(f"✓ {script_path} completed successfully")

        except subprocess.CalledProcessError as e:
            print(f"✗ Error running {script_path}:", file=sys.stderr)
            if e.stdout.strip():
                print(f"  stdout: {e.stdout.strip()}", file=sys.stderr)
            if e.stderr.strip():
                print(f"  stderr: {e.stderr.strip()}", file=sys.stderr)
            all_success = False

        except FileNotFoundError:
            print(f"✗ Error: Script not found at {script_full_path}", file=sys.stderr)
            all_success = False

        except Exception as e:
            print(f"✗ Unexpected error running {script_path}: {e}", file=sys.stderr)
            all_success = False

    return all_success

def main():
    try:
        success = prune_rm_notes()
        if not success:
            sys.exit(1)

        # Run additional scripts after pruning
        scripts_success = run_additional_scripts()
        if not scripts_success:
            sys.exit(1)

    except Exception as e:
        print(f"An unexpected error occurred: {e}", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    main()
