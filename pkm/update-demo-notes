#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.12"
# dependencies = []
# ///
"""
Script Requirements:
- As a user, I want to scan `~/code/notes` using `ripgrep` for Markdown files containing the tag `#demo-notes`.
- As a user, I want to copy these tagged files to `/home/connor/code/demo-notes-connor-engineer/source`, overwriting existing ones.
- As a user, I want to remove the `#demo-notes` tag from the copied files in the destination directory (not from the source files).
- As a user, I want to delete any Markdown file in the destination directory (except `index.md`) if it is not currently tagged with `#demo-notes` in the source.
- As a user, I want to remove the `build/html` directory to ensure a clean state.
- As a user, I want to execute the Sphinx build command via `uv` to regenerate the static site.
"""

import re
import shutil
import subprocess
import os
from pathlib import Path

# Configuration
SOURCE_NOTES_DIR = Path("~/code/notes").expanduser()
PROJECT_ROOT = Path("/home/connor/code/demo-notes-connor-engineer")
DEST_SOURCE_DIR = PROJECT_ROOT / "source"
BUILD_HTML_DIR = PROJECT_ROOT / "build" / "html"

TARGET_TAG = "#demo-notes"
INDEX_SOURCE = Path("/home/connor/notes/demo-notes-index.md")
INDEX_DEST = DEST_SOURCE_DIR / "index.md"


def get_tagged_files(directory: Path, tag: str) -> list[Path]:
    try:
        # -l lists filenames with matches, -t md restricts to markdown
        result = subprocess.run(
            ["rg", "-l", tag, str(directory), "-g", "*.md"],
            capture_output=True,
            text=True,
            check=False
        )
        if result.returncode == 0:
            return [Path(p) for p in result.stdout.strip().splitlines()]
        return []
    except FileNotFoundError:
        print("Error: ripgrep (rg) not found in PATH.")
        exit(1)


def convert_wikilinks_to_markdown(content: str, valid_filenames: set[str]) -> str:
    """
    Convert wikilinks [[filename]] to markdown links [filename](filename.md)
    Only convert links to files that exist in valid_filenames (with .md extension)
    """
    def replace_wikilink(match):
        link_target = match.group(1)
        # Convert spaces to hyphens for the filename
        target_filename = link_target.replace(' ', '-') + '.md'

        # Check if the target file exists in our valid filenames
        if target_filename in valid_filenames:
            return f"[{link_target}]({target_filename})"
        else:
            # Keep original wikilink if target file doesn't exist
            return match.group(0)

    # Pattern to match [[filename]]
    wikilink_pattern = r'\[\[([^\]]+)\]\]'
    return re.sub(wikilink_pattern, replace_wikilink, content)


def main():
    if not DEST_SOURCE_DIR.exists():
        os.makedirs(DEST_SOURCE_DIR)

    # 1. Identify Valid Files (Tag: #demo-notes)
    # We only need to scan once. These files are valid for copying AND keeping.
    print(f"üîç Scanning {SOURCE_NOTES_DIR} for files with tag '{TARGET_TAG}'...")
    tagged_source_files = get_tagged_files(SOURCE_NOTES_DIR, TARGET_TAG)
    print(f"üìù Found {len(tagged_source_files)} tagged files")
    
    # Create a set of filenames that SHOULD exist in the destination (with spaces replaced by hyphens)
    valid_filenames = {p.name.replace(' ', '-') for p in tagged_source_files}

    # 2. Copy Index File (hardcoded mapping)
    if INDEX_SOURCE.exists():
        print(f"üìã Copying index file: {INDEX_SOURCE.name} -> index.md...")
        shutil.copy2(INDEX_SOURCE, INDEX_DEST)

        # Process index file (remove tags, convert wikilinks)
        try:
            with open(INDEX_DEST, 'r', encoding='utf-8') as f:
                content = f.read()

            # Remove all hashtag tags (case-sensitive, whole line)
            lines = content.split('\n')
            cleaned_lines = [line for line in lines if not re.match(r'^\s*#[\w-]+\s*$', line.strip())]
            cleaned_content = '\n'.join(cleaned_lines)

            # Convert wikilinks to markdown links
            final_content = convert_wikilinks_to_markdown(cleaned_content, valid_filenames)

            with open(INDEX_DEST, 'w', encoding='utf-8') as f:
                f.write(final_content)

            print(f"  ‚úì {INDEX_SOURCE.name} -> index.md (hashtags removed, wikilinks converted)")
        except Exception as e:
            print(f"  ‚ö†Ô∏è  {INDEX_SOURCE.name} copied but processing failed: {e}")
    else:
        print(f"‚ö†Ô∏è  Index file {INDEX_SOURCE} not found")

    # 3. Copy Tagged Files and Clean #demo-notes Tag
    print(f"üìã Copying {len(tagged_source_files)} files to {DEST_SOURCE_DIR}...")
    for src_file in tagged_source_files:
        # Transform filename: replace spaces with hyphens
        dest_filename = src_file.name.replace(' ', '-')
        dest_file = DEST_SOURCE_DIR / dest_filename
        shutil.copy2(src_file, dest_file)

        # Remove #demo-notes tag and convert wikilinks from the destination file
        try:
            with open(dest_file, 'r', encoding='utf-8') as f:
                content = f.read()

            # Remove all hashtag tags (case-sensitive, whole line)
            lines = content.split('\n')
            cleaned_lines = [line for line in lines if not re.match(r'^\s*#[\w-]+\s*$', line.strip())]
            cleaned_content = '\n'.join(cleaned_lines)

            # Convert wikilinks to markdown links
            final_content = convert_wikilinks_to_markdown(cleaned_content, valid_filenames)

            with open(dest_file, 'w', encoding='utf-8') as f:
                f.write(final_content)

            if src_file.name != dest_filename:
                print(f"  ‚úì {src_file.name} -> {dest_filename} (hashtags removed, wikilinks converted)")
            else:
                print(f"  ‚úì {src_file.name} (hashtags removed, wikilinks converted)")
        except Exception as e:
            print(f"  ‚ö†Ô∏è  {src_file.name} copied but processing failed: {e}")

    # 4. Prune Files
    dest_files = list(DEST_SOURCE_DIR.glob("*.md"))
    files_removed = 0

    for dest_file in dest_files:
        if dest_file.name == "index.md":
            continue

        # If the destination file isn't in our current list of tagged files, delete it
        if dest_file.name not in valid_filenames:
            dest_file.unlink()
            files_removed += 1
            print(f"  üóëÔ∏è  Removed {dest_file.name}")

    if files_removed > 0:
        print(f"üßπ Removed {files_removed} untagged files")
    else:
        print("‚úÖ No files needed pruning")

    # 5. Rebuild Static Site
    print("üèóÔ∏è  Building static site with Sphinx...")
    try:
        # Use just build to ensure project dependencies are used (it also cleans)
        env = os.environ.copy()
        env.pop("VIRTUAL_ENV", None)  # Remove VIRTUAL_ENV to avoid conflicts
        subprocess.run(
            ["just", "build"],
            cwd=PROJECT_ROOT,
            check=True,
            env=env
        )
        print("‚úÖ Sphinx build completed successfully!")
    except subprocess.CalledProcessError as e:
        print(f"‚ùå Error: Sphinx build failed with exit code {e.returncode}")
        exit(1)
    except FileNotFoundError:
        print("‚ùå Error: 'just' command not found. Please install just.")
        exit(1)

if __name__ == "__main__":
    main()
