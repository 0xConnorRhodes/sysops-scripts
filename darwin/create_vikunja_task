#!/Users/connor.rhodes/.nix-profile/bin/uv run --script

# /// script
# requires-python = ">=3.11"
# dependencies = [
#     "httpx>=0.20.0",
#     "markdown-it-py>=3.0.0",
#     "mdit-py-plugins>=0.4.0",
# ]
# ///

# Required parameters:
# @raycast.schemaVersion 1
# @raycast.title Create Task

# Optional parameters:
# @raycast.argument1 { "type": "text", "placeholder": "Task description" }
# @raycast.mode silent

import sys
import argparse
import subprocess
import re
from datetime import date, timedelta, datetime
import zoneinfo
sys.path.insert(0, "/Users/connor.rhodes/code/vikunja-dev/module")

from vikunja import VikunjaClient


def is_url(text: str) -> bool:
    """Check if text is a valid URL."""
    if not text or not text.strip():
        return False
    url_pattern = re.compile(
        r'^(https?://|www\.)[\w\-]+(\.[\w\-]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?$',
        re.IGNORECASE
    )
    return bool(url_pattern.match(text.strip()))


def parse_start_date(task_content: str) -> tuple[str, str | None]:
    """
    Parse a +N pattern from task content and return (cleaned_title, start_date).
    Returns (original_content, None) if no pattern found.
    """
    pattern = r'\s*\+(\d+)\s*$'
    match = re.search(pattern, task_content)
    if match:
        days = int(match.group(1))
        cleaned_title = re.sub(pattern, '', task_content).strip()
        # Use local timezone to avoid date offset issues
        local_tz = zoneinfo.ZoneInfo('America/Chicago')
        target_date = datetime.now(local_tz).replace(hour=0, minute=0, second=0, microsecond=0) + timedelta(days=days)
        start_date = target_date.isoformat()
        return cleaned_title, start_date
    return task_content, None


parser = argparse.ArgumentParser()
parser.add_argument("--label", help="Label to add to the task")
parser.add_argument("task_content", help="Task description")
args = parser.parse_args()

vik = VikunjaClient()

# Get clipboard content
clipboard_result = subprocess.run(['pbpaste'], capture_output=True, text=True)
clipboard_content = clipboard_result.stdout.strip()

# Build description with URL if clipboard contains one
description = ""
if clipboard_content and is_url(clipboard_content):
    description = f"[{clipboard_content}]({clipboard_content})"

# Parse task content for start date pattern
cleaned_title, start_date = parse_start_date(args.task_content)

# Create task with optional label, description, and start date
task = vik.create_task(
    title=cleaned_title,
    label=args.label,
    description=description,
    start_date=start_date  # Will be None if no pattern found
)

# Open the task URL in browser
subprocess.run(['open', task.url])
print(f"âœ… Created: {cleaned_title}")
