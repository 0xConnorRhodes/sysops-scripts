#!/Users/connor.rhodes/.nix-profile/bin/uv run --script

# /// script
# requires-python = ">=3.12"
# dependencies = ["jinja2", "httpx", "markdown-it-py", "mdit-py-plugins"]
# ///

# @raycast.schemaVersion 1
# @raycast.title Task Report
# @raycast.argument1 { "type": "text", "placeholder": "Days ahead (default: 0)", "optional": true }
# @raycast.mode compact

import sys
sys.path.insert(0, "/Users/connor.rhodes/code/vikunja-dev/module")

from vikunja import VikunjaClient
from jinja2 import Template
import pathlib
import subprocess


def main():
    days_ahead = 0
    if len(sys.argv) > 1 and sys.argv[1].strip():
        try:
            days_ahead = int(sys.argv[1])
        except ValueError:
            print(f"Error: days_ahead must be an integer, got '{sys.argv[1]}'")
            sys.exit(1)

    v = VikunjaClient()
    tasks = v.get_future_tasks(days_ahead=days_ahead)

    if days_ahead == 0:
        title = "Today's Tasks"
    elif days_ahead == 1:
        title = "Today and Tomorrow's Tasks"
    else:
        title = f"Next {days_ahead + 1} Days' Tasks"

    template = Template("""
<html>
<body>
  <h1>{{ title }}</h1>
  <ul>
  {% for task in tasks %}
    <li><a href="{{ task.url }}" target="_blank" rel="noopener noreferrer">{{ task.title }}</a></li>
  {% endfor %}
  </ul>
</body>
</html>
""")

    html_output = template.render(tasks=tasks, title=title)
    output_path = pathlib.Path("/tmp/tasks_report.html")
    output_path.write_text(html_output)
    print(f"Generated {output_path} with {len(tasks)} tasks")
    subprocess.run(["open", str(output_path)])


if __name__ == "__main__":
    main()
