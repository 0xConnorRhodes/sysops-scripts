#!/Users/connor.rhodes/.nix-profile/bin/uv run --script

# /// script
# requires-python = ">=3.11"
# dependencies = [
#     "httpx>=0.20.0",
#     "markdown-it-py>=3.0.0",
#     "mdit-py-plugins>=0.4.0",
# ]
# ///

# @raycast.schemaVersion 1
# @raycast.title Create Work Task
# @raycast.argument1 { "type": "text", "placeholder": "Task description" }
# @raycast.mode silent

import sys
import subprocess
import re
sys.path.insert(0, "/Users/connor.rhodes/code/vikunja-dev/module")

from vikunja import VikunjaClient


def is_url(text: str) -> bool:
    """Check if text is a valid URL."""
    if not text or not text.strip():
        return False
    url_pattern = re.compile(
        r'^(https?://|www\.)[\w\-]+(\.[\w\-]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?$',
        re.IGNORECASE
    )
    return bool(url_pattern.match(text.strip()))


if len(sys.argv) < 2:
    sys.exit(0)
task_content = sys.argv[1]

vik = VikunjaClient()

# Get clipboard content
clipboard_result = subprocess.run(['pbpaste'], capture_output=True, text=True)
clipboard_content = clipboard_result.stdout.strip()

# Build description with URL if clipboard contains one
description = ""
if clipboard_content and is_url(clipboard_content):
    description = f"[{clipboard_content}]({clipboard_content})"

# Create work task with "w" label and optional description
task = vik.create_task(title=task_content, label="w", description=description)

subprocess.run(['open', task.url])
print(f"âœ… Created work task: {task_content}")
