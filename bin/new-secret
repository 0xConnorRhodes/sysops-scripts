#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.12"
# dependencies = [
#   "tomlkit",
# ]
# ///
"""
Script Requirements:
- As a user, I want to input an environment variable name that gets automatically transformed to uppercase with spaces replaced by underscores.
- As a user, I want to validate that the transformed environment variable name does not already exist in `fnox.toml`.
- As a user, I want to input a secret name (defaulting to the original user input before transformation).
- As a user, I want the script to check `rbw` to see if the secret name already exists.
- As a user, I want to be prompted for a new name if a conflict exists, with a suggestion formatted as `{cwd}-{original_name}`.
- As a user, I want to add the confirmed secret using `rbw add`, opening my default editor.
- As a user, I want to create or update `fnox.toml` in the current directory to map the transformed env var to the Bitwarden secret.
- As a user, I want the transformed environment variable name copied to my system clipboard automatically via pbcopy (macOS) or wl-copy (Linux).
- As a user, I want a summary message displayed at the end.
"""

import subprocess
import platform
from pathlib import Path
from tomlkit import document, table, parse, inline_table

def main():
    toml_path = Path("fnox.toml")

    # 1. Input Collection & Pre-validation
    while True:
        user_input = input("Enter env var name: ").strip()
        if not user_input:
            print("Environment variable name cannot be empty.")
            continue

        # Transform to uppercase and replace spaces with underscores
        env_var_name = user_input.upper().replace(" ", "_")

        if toml_path.exists():
            with open(toml_path, "r") as f:
                try:
                    check_doc = parse(f.read())
                    if "secrets" in check_doc and env_var_name in check_doc["secrets"]:
                        print(f"Error: '{env_var_name}' already exists in fnox.toml. Please choose a different name.")
                        continue
                except Exception:
                    pass

        break

    # Use the original user input as the default secret name
    raw_secret_name = input(f"Enter secret name (default: {user_input}): ").strip()
    secret_name = raw_secret_name if raw_secret_name else user_input
    original_name = secret_name

    # 2. RBW Search & Conflict Resolution
    while True:
        result = subprocess.run(
            ["rbw", "search", "--folder=secrets", secret_name],
            capture_output=True,
            text=True
        )

        if result.stdout.strip() == f"secrets/{secret_name}":
            print(f"The secret 'secrets/{secret_name}' already exists.")

            cwd_name = Path.cwd().name
            suggestion = f"{cwd_name}-{user_input}"

            new_input = input(f"Enter different name (default: {suggestion}): ").strip()
            secret_name = new_input if new_input else suggestion
        else:
            break

    subprocess.run(["rbw", "add", "--folder=secrets", secret_name])

    # 4. Modify fnox.toml
    if toml_path.exists():
        with open(toml_path, "r") as f:
            doc = parse(f.read())
    else:
        doc = document()

    if "secrets" not in doc:
        doc.add("secrets", table())

    secret_entry = inline_table()
    secret_entry["provider"] = "bitwarden"
    secret_entry["value"] = secret_name

    doc["secrets"][env_var_name] = secret_entry

    with open(toml_path, "w") as f:
        f.write(doc.as_string())

    # 5. Clipboard Operations
    os_type = platform.system()
    clipboard_msg = "Skipped clipboard (unsupported OS)"

    try:
        if os_type == "Darwin":
            process = subprocess.Popen(["pbcopy"], stdin=subprocess.PIPE)
            process.communicate(input=env_var_name.encode('utf-8'))
            clipboard_msg = "Copied to clipboard (pbcopy)"
        elif os_type == "Linux":
            process = subprocess.Popen(["wl-copy"], stdin=subprocess.PIPE)
            process.communicate(input=env_var_name.encode('utf-8'))
            clipboard_msg = "Copied to clipboard (wl-copy)"
    except FileNotFoundError as e:
        clipboard_msg = f"Clipboard failed ({e.filename} not found)"

    # 6. Summary
    print("\nSuccess:")
    print(f"- Added secret '{secret_name}' to Bitwarden (folder: secrets)")
    print(f"- Updated fnox.toml: {env_var_name} -> {secret_name}")
    print(f"- {clipboard_msg}")

if __name__ == "__main__":
    main()
