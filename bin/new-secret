#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.12"
# dependencies = [
#   "tomlkit",
# ]
# ///
"""
Script Requirements:
- As a user, I want to input an environment variable name and validate that it does not already exist in `fnox.toml`.
- As a user, I want to input a secret name (defaulting to the env var name).
- As a user, I want the script to check `rbw` to see if the secret name already exists.
- As a user, I want to be prompted for a new name if a conflict exists, with a suggestion formatted as `{cwd}-{original_name}`.
- As a user, I want to add the confirmed secret using `rbw add`, opening my default editor.
- As a user, I want to create or update `fnox.toml` in the current directory to map the env var to the Bitwarden secret.
- As a user, I want the environment variable name copied to my system clipboard automatically via pbcopy (macOS) or wl-copy (Linux).
- As a user, I want a summary message displayed at the end.
"""

import subprocess
import platform
from pathlib import Path
from tomlkit import document, table, parse, inline_table

def main():
    toml_path = Path("fnox.toml")
    
    # 1. Input Collection & Pre-validation
    while True:
        env_var_name = input("Enter env var name: ").strip()
        if not env_var_name:
            print("Environment variable name cannot be empty.")
            continue
            
        # Check if exists in fnox.toml immediately
        if toml_path.exists():
            with open(toml_path, "r") as f:
                # usage of try/except block handles empty or malformed files gracefully
                try:
                    check_doc = parse(f.read())
                    if "secrets" in check_doc and env_var_name in check_doc["secrets"]:
                        print(f"Error: '{env_var_name}' already exists in fnox.toml. Please choose a different name.")
                        continue
                except Exception:
                    # If file is unparseable, we assume it's safe to proceed or user will fix it later
                    pass
        
        # If we get here, the name is valid
        break

    raw_secret_name = input(f"Enter secret name (default: {env_var_name}): ").strip()
    secret_name = raw_secret_name if raw_secret_name else env_var_name
    original_name = secret_name

    # 2. RBW Search & Conflict Resolution
    while True:
        # Run search command
        result = subprocess.run(
            ["rbw", "search", "--folder=secrets", secret_name],
            capture_output=True,
            text=True
        )
        
        # strict check based on prompt requirements
        if result.stdout.strip() == f"secrets/{secret_name}":
            print(f"The secret 'secrets/{secret_name}' already exists.")
            
            cwd_name = Path.cwd().name
            suggestion = f"{cwd_name}-{original_name}"
            
            new_input = input(f"Enter different name (default: {suggestion}): ").strip()
            secret_name = new_input if new_input else suggestion
        else:
            # No match found, proceed
            break

    # 3. Add Secret via RBW
    subprocess.run(["rbw", "add", "--folder=secrets", secret_name])

    # 4. Modify fnox.toml
    # Re-read the file to ensure we have the latest state after the blocking rbw call
    if toml_path.exists():
        with open(toml_path, "r") as f:
            doc = parse(f.read())
    else:
        doc = document()

    if "secrets" not in doc:
        doc.add("secrets", table())

    # Create inline table: { provider = "bitwarden", value = "NAME" }
    secret_entry = inline_table()
    secret_entry["provider"] = "bitwarden"
    secret_entry["value"] = secret_name
    
    doc["secrets"][env_var_name] = secret_entry

    with open(toml_path, "w") as f:
        f.write(doc.as_string())

    # 5. Clipboard Operations
    os_type = platform.system()
    clipboard_msg = "Skipped clipboard (unsupported OS)"
    
    try:
        if os_type == "Darwin":
            process = subprocess.Popen(["pbcopy"], stdin=subprocess.PIPE)
            process.communicate(input=env_var_name.encode('utf-8'))
            clipboard_msg = "Copied to clipboard (pbcopy)"
        elif os_type == "Linux":
            process = subprocess.Popen(["wl-copy"], stdin=subprocess.PIPE)
            process.communicate(input=env_var_name.encode('utf-8'))
            clipboard_msg = "Copied to clipboard (wl-copy)"
    except FileNotFoundError as e:
        clipboard_msg = f"Clipboard failed ({e.filename} not found)"

    # 6. Summary
    print("\nSuccess:")
    print(f"- Added secret '{secret_name}' to Bitwarden (folder: secrets)")
    print(f"- Updated fnox.toml: {env_var_name} -> {secret_name}")
    print(f"- {clipboard_msg}")

if __name__ == "__main__":
    main()
