#!/usr/bin/env python3
"""
Video processing script that:
1. Finds all supported video files in current working directory
2. Runs unsilence to remove silence and apply volume reduction in a single step
"""

import os
import glob
import subprocess
from pathlib import Path

SUPPORTED_EXTENSIONS = ['mp4', 'mov', 'mkv', 'avi', 'webm']

VOL_ADJUST = 0.07

def run_command(command, description):
    """Run a shell command with visible output"""
    print(f"\n=== {description} ===")
    print(f"Running: {command}")

    try:
        result = subprocess.run(command, shell=True, check=True)
        print(f"✓ Completed: {description}")
        return True
    except subprocess.CalledProcessError as e:
        print(f"✗ Error in {description}: {e}")
        return False


def main():
    cwd = os.getcwd()
    print(f"Working in directory: {cwd}")

    print(f"\n=== Finding video files ({', '.join(ext.upper() for ext in SUPPORTED_EXTENSIONS)}) ===")
    video_files = []
    for ext in SUPPORTED_EXTENSIONS:
        video_files.extend(glob.glob(f"*.{ext}"))
        video_files.extend(glob.glob(f"*.{ext.upper()}"))

    # Remove duplicates while preserving order
    video_files = list(dict.fromkeys(video_files))

    if not video_files:
        print(f"No video files found in current directory! (Supported: {', '.join(SUPPORTED_EXTENSIONS)})")
        return

    print(f"Found {len(video_files)} video files:")
    for file in video_files:
        print(f"  - {file}")

    print("\n=== Creating directories ===")
    processed_dir = Path("processed")
    unsilenced_dir = processed_dir / "unsilenced"

    processed_dir.mkdir(exist_ok=True)
    print(f"✓ Created/verified: {processed_dir}")
    unsilenced_dir.mkdir(exist_ok=True)
    print(f"✓ Created/verified: {unsilenced_dir}")

    print(f"\n=== Processing {len(video_files)} files with unsilence ===")
    successful_unsilenced = []

    for video_file in video_files:
        output_file = unsilenced_dir / video_file
        # Note: No -ao flag to preserve video track
        command = f'unsilence -y -av {VOL_ADJUST} "{video_file}" "{output_file}"'

        if run_command(command, f"Unsilencing {video_file}"):
            successful_unsilenced.append(output_file)
        else:
            print(f"⚠️ Failed {video_file} due to unsilence error")
            exit(1)

    print("\n=== Processing Complete ===")
    print(f"Original files: {len(video_files)}")
    print(f"Successfully processed: {len(successful_unsilenced)}")
    print(f"Processed files in: {unsilenced_dir}")


if __name__ == "__main__":
    main()
