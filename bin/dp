#!/bin/sh

REMOTE_SRC_DIR="m:/scary/files/share/drop"
ORIGINAL_CWD="$(pwd)"

set -e

# Parse the remote source string into host and directory components
REMOTE_HOST=$(echo "$REMOTE_SRC_DIR" | cut -d: -f1)
REMOTE_DIR=$(echo "$REMOTE_SRC_DIR" | cut -d: -f2-)

# Get list of all files in remote directory
ALL_FILENAMES=$(ssh "$REMOTE_HOST" "find '$REMOTE_DIR' -maxdepth 1 -type f -printf '%f\n'")

if [ -z "$ALL_FILENAMES" ]; then
  echo "No files found in remote directory." >&2
  exit 1
fi

# Count the number of files
FILE_COUNT=$(echo "$ALL_FILENAMES" | wc -l)

# Determine destination directory
if [ "$FILE_COUNT" -gt 1 ]; then
  LOCAL_DEST_DIR="$ORIGINAL_CWD/drop"
  mkdir -p "$LOCAL_DEST_DIR"
  echo "Downloading $FILE_COUNT files to $LOCAL_DEST_DIR"
else
  LOCAL_DEST_DIR="$ORIGINAL_CWD"
  echo "Downloading 1 file to $LOCAL_DEST_DIR"
fi

# Download all files
rsync -av --progress --remove-source-files "$REMOTE_HOST:$REMOTE_DIR/" "$LOCAL_DEST_DIR/"
