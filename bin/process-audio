#!/usr/bin/env python3
"""
Audio processing script that:
1. Finds all supported audio files in current working directory
2. Runs unsilence to remove silence
3. Applies volume reduction with ffmpeg
"""

import os
import glob
import subprocess
from pathlib import Path

# Supported audio file extensions (case insensitive)
SUPPORTED_EXTENSIONS = ['mp3', 'm4a']

VOL_ADJUST = 0.06

def run_command(command, description):
    """Run a shell command with visible output"""
    print(f"\n=== {description} ===")
    print(f"Running: {command}")

    try:
        result = subprocess.run(command, shell=True, check=True)
        print(f"✓ Completed: {description}")
        return True
    except subprocess.CalledProcessError as e:
        print(f"✗ Error in {description}: {e}")
        return False


def main():
    cwd = os.getcwd()
    print(f"Working in directory: {cwd}")

    print(f"\n=== Finding audio files ({', '.join(ext.upper() for ext in SUPPORTED_EXTENSIONS)}) ===")
    audio_files = []
    for ext in SUPPORTED_EXTENSIONS:
        # Find files with both lowercase and uppercase extensions
        audio_files.extend(glob.glob(f"*.{ext}"))
        audio_files.extend(glob.glob(f"*.{ext.upper()}"))

    # Remove duplicates while preserving order
    audio_files = list(dict.fromkeys(audio_files))

    if not audio_files:
        print(f"No audio files found in current directory! (Supported: {', '.join(SUPPORTED_EXTENSIONS)})")
        return

    print(f"Found {len(audio_files)} audio files:")
    for file in audio_files:
        print(f"  - {file}")

    print("\n=== Creating directories ===")
    processed_dir = Path("processed")
    unsilenced_dir = processed_dir / "unsilenced"
    unsilenced_and_lowvol_dir = processed_dir / "unsilenced_and_lowvol"

    processed_dir.mkdir(exist_ok=True)
    print(f"✓ Created/verified: {processed_dir}")
    unsilenced_dir.mkdir(exist_ok=True)
    print(f"✓ Created/verified: {unsilenced_dir}")
    unsilenced_and_lowvol_dir.mkdir(exist_ok=True)
    print(f"✓ Created/verified: {unsilenced_and_lowvol_dir}")

    print(f"\n=== Processing {len(audio_files)} files with unsilence ===")
    successful_unsilenced = []

    for audio_file in audio_files:
        output_file = unsilenced_dir / audio_file
        command = f'unsilence -y -ao "{audio_file}" "{output_file}"'

        if run_command(command, f"Unsilencing {audio_file}"):
            successful_unsilenced.append(output_file)
        else:
            print(f"⚠️ Failed {audio_file} due to unsilence error")
            exit(1)

    print(f"\n=== Finding processed files in {unsilenced_dir} ===")
    unsilenced_files = []
    for ext in SUPPORTED_EXTENSIONS:
        # Find files with both lowercase and uppercase extensions
        unsilenced_files.extend(unsilenced_dir.glob(f"*.{ext}"))
        unsilenced_files.extend(unsilenced_dir.glob(f"*.{ext.upper()}"))

    # Remove duplicates while preserving order
    unsilenced_files = list(dict.fromkeys(unsilenced_files))

    if not unsilenced_files:
        print(f"No audio files found in unsilenced directory! (Supported: {', '.join(SUPPORTED_EXTENSIONS)})")
        return

    print(f"Found {len(unsilenced_files)} unsilenced audio files:")
    for file in unsilenced_files:
        print(f"  - {file.name}")

    print(f"\n=== Processing {len(unsilenced_files)} files with ffmpeg (volume reduction) ===")

    for audio_file in unsilenced_files:
        output_file = unsilenced_and_lowvol_dir / audio_file.name
        command = f'ffmpeg -i "{audio_file}" -filter:a volume={VOL_ADJUST} "{output_file}"'

        run_command(command, f"Reducing volume for {audio_file.name}")

    print("\n=== Processing Complete ===")
    print(f"Original files: {len(audio_files)}")
    print(f"Successfully unsilenced: {len(successful_unsilenced)}")
    print(f"Final processed files in: {unsilenced_and_lowvol_dir}")


if __name__ == "__main__":
    main()
